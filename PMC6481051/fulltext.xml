<!DOCTYPE article PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Archiving and Interchange DTD v1.2 20190208//EN" "JATS-archivearticle1.dtd"> 
<article xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:mml="http://www.w3.org/1998/Math/MathML" article-type="other"><?properties open_access?><?DTDIdentifier.IdentifierValue -//NLM//DTD JATS (Z39.96) Journal Publishing DTD v1.1 20151215//EN?><?DTDIdentifier.IdentifierType public?><?SourceDTD.DTDName JATS-journalpublishing1.dtd?><?SourceDTD.Version 1.1?><?ConverterInfo.XSLTName jp2nlmx2.xsl?><?ConverterInfo.Version 1?><front><journal-meta><journal-id journal-id-type="nlm-ta">Methods Protoc</journal-id><journal-id journal-id-type="iso-abbrev">Methods Protoc</journal-id><journal-id journal-id-type="publisher-id">mps</journal-id><journal-title-group><journal-title>Methods and Protocols</journal-title></journal-title-group><issn pub-type="epub">2409-9279</issn><publisher><publisher-name>MDPI</publisher-name></publisher></journal-meta><article-meta><article-id pub-id-type="pmcid">6481051</article-id><article-id pub-id-type="doi">10.3390/mps2010007</article-id><article-id pub-id-type="publisher-id">mps-02-00007</article-id><article-categories><subj-group subj-group-type="heading"><subject>Technical Note</subject></subj-group></article-categories><title-group><article-title>A Software Architecture to Mimic a Ventricular Tachycardia in Intact Murine Hearts by Means of an All-Optical Platform</article-title></title-group><contrib-group><contrib contrib-type="author"><contrib-id contrib-id-type="orcid" authenticated="true">https://orcid.org/0000-0001-8301-2864</contrib-id><name><surname>Giardini</surname><given-names>Francesco</given-names></name><xref ref-type="aff" rid="af1-mps-02-00007">1</xref></contrib><contrib contrib-type="author"><name><surname>Biasci</surname><given-names>Valentina</given-names></name><xref ref-type="aff" rid="af1-mps-02-00007">1</xref><xref ref-type="aff" rid="af2-mps-02-00007">2</xref></contrib><contrib contrib-type="author"><name><surname>Scardigli</surname><given-names>Marina</given-names></name><xref ref-type="aff" rid="af1-mps-02-00007">1</xref></contrib><contrib contrib-type="author"><name><surname>Pavone</surname><given-names>Francesco S.</given-names></name><xref ref-type="aff" rid="af1-mps-02-00007">1</xref><xref ref-type="aff" rid="af3-mps-02-00007">3</xref></contrib><contrib contrib-type="author"><name><surname>Bub</surname><given-names>Gil</given-names></name><xref ref-type="aff" rid="af4-mps-02-00007">4</xref></contrib><contrib contrib-type="author"><contrib-id contrib-id-type="orcid" authenticated="true">https://orcid.org/0000-0002-9320-5085</contrib-id><name><surname>Sacconi</surname><given-names>Leonardo</given-names></name><xref ref-type="aff" rid="af1-mps-02-00007">1</xref><xref ref-type="aff" rid="af3-mps-02-00007">3</xref><xref rid="c1-mps-02-00007" ref-type="corresp">*</xref></contrib></contrib-group><aff id="af1-mps-02-00007"><label>1</label>European Laboratory for Non-Linear Spectroscopy, 50019 Sesto Fiorentino, Italy; <email>giardini@lens.unifi.it</email> (F.G.); <email>biasci@lens.unifi.it</email> (V.B.); <email>scardigli@lens.unifi.it</email> (M.S.); <email>pavone@lens.unifi.it</email> (F.S.P.)</aff><aff id="af2-mps-02-00007"><label>2</label>Division of Physiology, Department of Experimental and Clinical Medicine, University of Florence, 50134 Florence, Italy</aff><aff id="af3-mps-02-00007"><label>3</label>National Institute of Optics, National Research Council, 50125 Florence, Italy</aff><aff id="af4-mps-02-00007"><label>4</label>Department of Physiology, McGill University, Montreal, QC H3A 0G4, Canada; <email>gilbub@gmail.com</email></aff><author-notes><corresp id="c1-mps-02-00007"><label>*</label>Correspondence: <email>sacconi@lens.unifi.it</email>; Tel.: +39-055-4572451</corresp></author-notes><pub-date pub-type="epub"><day>08</day><month>1</month><year>2019</year></pub-date><pub-date pub-type="collection"><month>3</month><year>2019</year></pub-date><volume>2</volume><issue>1</issue><elocation-id>7</elocation-id><history><date date-type="received"><day>29</day><month>11</month><year>2018</year></date><date date-type="accepted"><day>04</day><month>1</month><year>2019</year></date></history><permissions><copyright-statement>&#x000a9; 2019 by the authors.</copyright-statement><copyright-year>2019</copyright-year><license license-type="open-access"><license-p>Licensee MDPI, Basel, Switzerland. This article is an open access article distributed under the terms and conditions of the Creative Commons Attribution (CC BY) license (<ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link>).</license-p></license></permissions><abstract><p>Optogenetics is an emerging method that uses light to manipulate electrical activity in excitable cells exploiting the interaction between light and light-sensitive depolarizing ion channels, such as channelrhodopsin-2 (ChR2). Initially used in the neuroscience, it has been adopted in cardiac research where the expression of ChR2 in cardiac preparations allows optical pacing, resynchronization and defibrillation. Recently, optogenetics has been leveraged to manipulate cardiac electrical activity in the intact heart in real-time. This new approach was applied to simulate a re-entrant circuit across the ventricle. In this technical note, we describe the development and the implementation of a new software package for real-time optogenetic intervention. The package consists of a single LabVIEW program that simultaneously captures images at very high frame rates and delivers precisely timed optogenetic stimuli based on the content of the images. The software implementation guarantees closed-loop optical manipulation at high temporal resolution by processing the raw data in workstation memory. We demonstrate that this strategy allows the simulation of a ventricular tachycardia with high stability and with a negligible loss of data with a temporal resolution of up to 1 ms.</p></abstract><kwd-group><kwd>optical mapping</kwd><kwd>voltage imaging</kwd><kwd>voltage sensitive dye</kwd><kwd>optical manipulation</kwd><kwd>optogenetics</kwd><kwd>channelrhodopsin-2</kwd><kwd>cardiac electrophysiology</kwd><kwd>LabVIEW</kwd><kwd>closed-loop</kwd><kwd>real-time analysis</kwd></kwd-group></article-meta></front><body><sec sec-type="intro" id="sec1-mps-02-00007"><title>1. Introduction</title><p>Optogenetics is an emerging technique that involves the use of light to control the electrical activity of excitable cells. Expression of light-sensitive depolarizing ion channels such as ChR2 in excitable cells enables a fast-excitatory response to illumination [<xref rid="B1-mps-02-00007" ref-type="bibr">1</xref>,<xref rid="B2-mps-02-00007" ref-type="bibr">2</xref>,<xref rid="B3-mps-02-00007" ref-type="bibr">3</xref>]. From applications in neuroscience, optogenetics has been widely extended to cardiac research [<xref rid="B4-mps-02-00007" ref-type="bibr">4</xref>,<xref rid="B5-mps-02-00007" ref-type="bibr">5</xref>,<xref rid="B6-mps-02-00007" ref-type="bibr">6</xref>,<xref rid="B7-mps-02-00007" ref-type="bibr">7</xref>,<xref rid="B8-mps-02-00007" ref-type="bibr">8</xref>,<xref rid="B9-mps-02-00007" ref-type="bibr">9</xref>,<xref rid="B10-mps-02-00007" ref-type="bibr">10</xref>,<xref rid="B11-mps-02-00007" ref-type="bibr">11</xref>,<xref rid="B12-mps-02-00007" ref-type="bibr">12</xref>,<xref rid="B13-mps-02-00007" ref-type="bibr">13</xref>,<xref rid="B14-mps-02-00007" ref-type="bibr">14</xref>]. Several therapeutic approaches based on optogenetics have recently been reported: Nussinovitch and Gepstein [<xref rid="B15-mps-02-00007" ref-type="bibr">15</xref>] described the first use of optogenetics for cardiac resynchronization while other groups [<xref rid="B16-mps-02-00007" ref-type="bibr">16</xref>,<xref rid="B17-mps-02-00007" ref-type="bibr">17</xref>,<xref rid="B18-mps-02-00007" ref-type="bibr">18</xref>,<xref rid="B19-mps-02-00007" ref-type="bibr">19</xref>,<xref rid="B20-mps-02-00007" ref-type="bibr">20</xref>] have demonstrated optical defibrillation of arrhythmic hearts. In this context, Crocini and colleagues [<xref rid="B19-mps-02-00007" ref-type="bibr">19</xref>] developed an optical platform that can generate novel stimulation strategies with the aim of developing new cardiac defibrillation strategies: a wide-field mesoscope to map the action potential propagation across perfused mouse hearts was implemented with an ultrafast scanning laser system to manipulate cardiac electrical activity with arbitrarily chosen channelrhodopsin-2 (ChR2) stimulation patterns. This optical toolkit enabled full optical control of cardiac conduction at sub-ms temporal resolution in whole isolated mouse hearts. However, an important feature was missing: the capability to interact with the cardiac tissue based on the ongoing electrical activity. We recently addressed this issue by using a closed-loop approach where the stimulation was directly triggered by cardiac dynamics in real-time in intact hearts [<xref rid="B21-mps-02-00007" ref-type="bibr">21</xref>]. Our approach uses a computer-controlled digital micro-mirror device (DMD) to control cardiac excitation waves in real time with pre-defined stimulation pattern (<xref ref-type="fig" rid="mps-02-00007-f001">Figure 1</xref>A). The system was successfully used to manipulate intraventricular propagation, atrioventricular delay, and to mimic pathologies by imposing a re-entrant circuit in a healthy heart. In the latter example, a light pulse delivered to the apex of a ChR2 expressing heart induced a wave that propagated to the heart base, and once an action potential was optically detected in a selected region of interest, a new trigger was generated in the apex with a certain delay (<xref ref-type="fig" rid="mps-02-00007-f001">Figure 1</xref>B). This experiment was the first demonstration of an all-optical system that can generate a user defined re-entrant circuit in an intact heart preparation. Here, we describe an improved version of the software that can optically mimic a ventricular tachycardia with high stability, negligible data loss, and with unprecedented temporal resolution.</p></sec><sec id="sec2-mps-02-00007"><title>2. Materials and Methods</title><p><bold>Optical platform.</bold> As described in [<xref rid="B21-mps-02-00007" ref-type="bibr">21</xref>], the whole mouse heart was illuminated in wide-field configuration using a 2&#x000d7; objective and a LED (light-emitting diode) operating at a wavelength centered at 625 nm, followed by a band-pass filter at 640/40 nm. A dichroic beam splitter followed by a band-pass filter at 775/140 nm were used for collecting the emitted fluorescence from a voltage-sensitive dye (VSD) used for staining the heart. A 20&#x000d7; objective was used to focus the fluorescence in a central portion (128 &#x000d7; 128) px of the sensor of a scientific complementary metal-oxide semiconductor camera (sCMOS camera), corresponding to a field of view of about (10 &#x000d7; 10) mm in the sample plane. The camera is set to run in free-run mode, with frame rate determined by exposure time. A Texas Instruments Lightcrafter 4500 projector (Dallas, TX, USA), containing a DMD, was used to manipulate electrical activity of the heart by projecting user-defined light patterns onto the heart. All microscope components were fixed onto a custom vertical honeycomb steel breadboard. The workstation is a Dell running a 64 bits version of Windows 7 Professional, 32 GB RAM and an Intel Xeon processor E5-1630 v3 at 3.70 GHz. For all details, see [<xref rid="B21-mps-02-00007" ref-type="bibr">21</xref>].</p><p><bold>Sample preparation.</bold> All animal handling and procedures were performed in accordance with the guidelines from the Directive 2010/63/EU of the European Parliament on the protection of animals used for scientific purposes. The experimental protocol was approved by the Italian Ministry of Health (protocol number 647/2015-PR). As described in [<xref rid="B21-mps-02-00007" ref-type="bibr">21</xref>], transgenic mice were heparinized (5000 units/mL) and anesthetized by inhaled isoflurane (5%). The excised heart was immediately bathed in Krebs&#x02013;Henseleit (KH) solution and cannulated through the aorta. Contraction was inhibited with blebbistatin (5 &#x003bc;M) in the solution. The cannulated heart was retrogradely perfused (Langendorff perfusion) with the KH solution and then transferred to the recording chamber at a constant flow of 2&#x02013;5 mL/min at 22 &#x000b0;C (room temperature). After few minutes, 1 mL of perfusion solution containing the voltage sensitive dye (di-4-ANBDQPQ, 50 &#x000b5;g/mL) [<xref rid="B22-mps-02-00007" ref-type="bibr">22</xref>] was bolus injected into the aorta.</p></sec><sec id="sec3-mps-02-00007"><title>3. Software Architecture</title><sec id="sec3dot1-mps-02-00007"><title>3.1. General Architecture and Funcionality</title><p>We developed a single custom LabVIEW software program (LabVIEW 2015, Version 15.0 64-bit, National Instruments, Austin, TX, USA) to implement the optical platform described in Scardigli et al. [<xref rid="B21-mps-02-00007" ref-type="bibr">21</xref>]. The goal of this solution is to simultaneously manage the sCMOS camera system (OrcaFlash4.0, Hamamatsu, Shizuoka, Japan) for fast imaging, the real-time image analysis and the DMD-based optical stimulator (DLPLCR4500EVM, Texas Instruments, Dallas, TX, USA). In order to achieve fast feedback control, camera management has been integrated in the main LabVIEW program using the Hamamatsu Video Capture Library (HVCL, Version 4.2, 2017; Hamamatsu City, Shizuoka, Japan), so the raw data from the camera is directly fast stacked and instantly analyzed in memory, without incurring time expensive external backups. The program allows two operating modalities: free-run mode (i.e., optical mapping without active control) and closed-loop mode. Both modalities exploit the 16-bit performance of our sCMOS sensor and it is possible to switch between these modes at any point during the experiment. The closed-loop modality was developed to mimic a re-entrant ventricular tachycardia by performing the real-time optical mapping and stimulation protocol described above.</p><p>The software is based on two parallel asynchronous loops: the imaging loop (IL in <xref ref-type="fig" rid="mps-02-00007-f002">Figure 2</xref>A), and the real-time analysis loop (RTL in <xref ref-type="fig" rid="mps-02-00007-f002">Figure 2</xref>A). The first manages the camera acquisition, stacks the camera data in RAM and controls the effective system frame rate. The second loop manages the stimulation protocol based on the analysis of the current camera data. In this configuration, system stability is guaranteed because the RTL is faster than IL. We decide to use two independent loops to allow image acquisition during all phases of the optically-induced re-entrant circuit. The analysis is based on a region of interest (ROI) selection in the camera frame; the ROI is set by the user before the real-time operation. The graphical user interface (GUI) allows also to set the following parameters: the exposure time of the camera, excitation LED (red LED) current, action potential depolarization threshold (percentage of &#x00394;F/F, where F represents the VSD fluorescence signal) within the selected ROI, DMD LED (blue LED) current, stimulation pulse length and delay. The system first performs some preliminary operations to prepare the sCMOS camera and turn on the red LED before starting the imaging loop. When the closed-loop modality is active, the real time analysis is performed with every new image acquisition. Finally, the system manages the operations for correctly closing the camera connection and saving all the frames stacked in memory. A detailed description of these operating modalities is found in the following paragraphs. The LabVIEW software is available at: <uri xlink:href="https://cuoricino.fisica.unifi.it/share.cgi?ssid=0hGs1Tb">https://cuoricino.fisica.unifi.it/share.cgi?ssid=0hGs1Tb</uri>.</p></sec><sec id="sec3dot2-mps-02-00007"><title>3.2. Preliminary Operations</title><p>When the program starts, the user can select a ROI in a pre-existing image by drawing a rectangle on a heart region (for example, at the base of the heart). Contemporaneously, the program initializes the camera executing INITIALIZE function from HVCL. Inside the main program, the first operation is to turn on the red LED (<xref ref-type="fig" rid="mps-02-00007-f002">Figure 2</xref>A): the LED voltage is read by the GUI and sent by a multi-function I/O device (USB-6212, National Instruments, Austin, TX, USA) to the LED driver. Afterwards, based on the camera index, the camera is opened (executing the OPENCAMERA function from HVCL) and only the central 128 &#x000d7; 128 px area of the 2048 &#x000d7; 2048 px sensor is set (<xref ref-type="fig" rid="mps-02-00007-f002">Figure 2</xref>B,C) and employed (executing the SETAREA function from HVCL) allowing fast imaging [<xref rid="B21-mps-02-00007" ref-type="bibr">21</xref>]. Furthermore, a generic SETPARAMETER function is used to set the sensor exposure time, while the PREPARECAPTURE function sets the acquisition in &#x0201c;sequence&#x0201d; modality (free run acquisition). Finally, the STARTCAPTURE function begins capturing of image data from the camera and IL is started.</p></sec><sec id="sec3dot3-mps-02-00007"><title>3.3. Imaging Loop</title><p>As mentioned above, the IL manages the camera acquisition, stacks the data in RAM and controls the real frame rate of the system. Here, the GETFRAME function (<xref ref-type="fig" rid="mps-02-00007-f002">Figure 2</xref>A) reads from the camera the current frame (managed as 128 &#x000d7; 128 unsigned 16-bit matrix) and the timestamp (a camera time reference for the current frame). Then WAITNEXTFRAME function waits until GETFRAME gives the new frame: when a new frame and timestamp are ready, these are written in a local variable and stacked in RAM. After this, the WAITNEXTFRAME function waits for the next frame from the camera and the cycle repeats itself. The loop also allows the visualization of the current frame in the GUI when the &#x0201c;visualize frame&#x0201d; option is set. This option is very CPU expensive and it is generally disabled during fast imaging and real-time analysis. The IL continually checks the actual frame rate using the workstation timestamp that is compared with the previous one at every cycle using a dedicated shift register.</p></sec><sec id="sec3dot4-mps-02-00007"><title>3.4. Real-Time Analysis Loop</title><p>Real-time analysis loop is the core of the main program, and it is executed by setting the RT option in the GUI. When the first frame is written in local memory, the program calculates the average (m) of the fluorescence signal within the user-defined ROI (see <xref ref-type="fig" rid="mps-02-00007-f002">Figure 2</xref>). At the first cycle, the shift register buffer is empty, so m is written in the buffer. By the second cycle the loop starts its comparative procedure to calculate the fluorescence ratio (&#x00394;F/F). The current m value is compared with the m-values stored in the buffer: m is subtracted from the buffer vector and the result is divided by the buffer itself producing a relative variation vector. If one value of this resulting vector is bigger than the user-defined threshold (Th) a depolarization event is detected in the ROI area and a stimulation protocol is triggered. Stable operation is guaranteed when RTL is faster than IL (timed by the exposure time), where the comparison procedure is performed with each frame.</p></sec><sec id="sec3dot5-mps-02-00007"><title>3.5. Stimulation Protocol</title><p>When a depolarization event is detected, the platform optically stimulates the sample with the blue LED, using the DMD-based Lightcrafter displaying a pre-defined pattern [<xref rid="B21-mps-02-00007" ref-type="bibr">21</xref>]. The stimulation protocol is composed of three sequential steps: a pre-activation delay, LED activation and a post-activation delay. The pre-activation delay is the time between the detection event and the optogenetic stimulation. Then, the platform illuminates the heart with a pulse of light: the driving voltage of blue LED is read by the GUI and sent to a multi-function I/O device (USB-6002, National Instruments, Austin, TX, USA) together with an enable digital command for the duration of the pulse width. Lastly, the system waits for a post-activation delay before restarting the ROI analysis; this post-activation delay guarantees that the system does not detect unwanted fluorescence variation related to optogenetic stimulation. Finally, the buffer is reset and the RTL looks for a new depolarization event.</p></sec><sec id="sec3dot6-mps-02-00007"><title>3.6. Final Operations</title><p>At the end of the measurement, IL and RTL can be stopped using a dedicated button in the GUI. After loops are interrupted, a set of operations are necessary to correctly close the camera (<xref ref-type="fig" rid="mps-02-00007-f002">Figure 2</xref>D): (i) the HVCL STOPCAPTURE function stops the acquisition of the camera; (ii) UNPREPARECAPTURE makes available all resources created with PREPARECAPTURE; (iii) CLOSECAMERA closes the camera; and (iv) finally, DEINITIALIZECAMERA function deactivates the camera and makes available all resources used by the video capture library. The system also turns off the red LED (by setting the LED current to zero) and the program queries the user to save all the acquired frames. After the prompt, a save image loop starts and every frame matrix stored in RAM is converted to a 16-bit 128 &#x000d7; 128 grayscale tiff image and saved to solid-state disk. The timestamp of each frame is used as its filename, and when all frames are saved the program ends.</p></sec></sec><sec sec-type="results" id="sec4-mps-02-00007"><title>4. Results and Discussion</title><p>Here, we evaluated the performance of our hardware and software architecture in terms of speed and stability during free-run and closed-loop imaging modalities. When reducing the frame integration time, the data transfer capability and workstation resources may not be sufficient to perform all required operations and a frame can be accidentally skipped during acquisition and/or RT analysis. A stress test was developed in order to estimate the relation between time resolution (exposure time) and the error rate of both IL and RTL. We have first measured IL performance calculating the fraction of lost frames during 90 s of recording applying different exposure times. The test was performed without and with the RT analysis (blue and red triangle respectively in <xref ref-type="fig" rid="mps-02-00007-f003">Figure 3</xref>) to quantify the impact of the RTL execution during image acquisition. We found that with exposure times &#x02265;1 ms the error rate is less than 1% for both configurations (RTL disabled and RTL enabled). Then, using a similar approach, we quantified the RTL performance measuring the fraction of the acquired frames that have not been analyzed during 90 s of RT protocol (black circles in <xref ref-type="fig" rid="mps-02-00007-f003">Figure 3</xref>). We found an error &#x0003c;0.4% for each exposure time. Based on this observation, the data transfer capability represents the bottleneck of our system, and we can define a time resolution limit as 1 ms.</p><p>We tested the stability of the system over a three-minute recording window with a temporal resolution of 2 ms. The heart was optogenetically stimulated at the apex using a circular spot (1 mm in diameter) and a detection ROI (0.1 &#x000d7; 0.3 mm) was placed at the heart base (<xref ref-type="fig" rid="mps-02-00007-f004">Figure 4</xref>a).</p><p>The used experimental parameters were as follows: illumination intensity 1 mW/mm<sup>2</sup>; optogenetic stimulation intensity 4 mW/mm<sup>2</sup>; pulse duration 5 ms; pre-activation delay 200 ms; post-activation delay 5 ms; detection threshold 1%. As fully described in Scardigli et al. [<xref rid="B21-mps-02-00007" ref-type="bibr">21</xref>], a threshold of 1% of &#x00394;F/F was chosen based on a typical shot noise at rest within our ROI of 0.2&#x02013;0.02% of &#x00394;F/F and a VSD sensitivity of ~4%. <xref ref-type="fig" rid="mps-02-00007-f004">Figure 4</xref>b shows the optical trace obtained. The stability of the system in different preparations was confirmed by successfully simulating ventricular tachycardia in five hearts using different recording durations (from 25 s to 3 min).</p><p>As described above, the system stores all images in RAM during imaging and processing and it saves the entire dataset at the end of the measurement. Although this approach results in a very high temporal resolution, it could limit the measuring time. For example, acquiring (128 &#x000d7; 128) px 16-bit images at 1 kHz uses 1.875 GB of RAM for every minute of recording.</p><p>The ability to stably mimic re-entrant circuits can be leveraged to generate biological models of different pathological conditions. Different delays and /or different stimulation patterns can be tested in order to fully characterize the stability of ventricular tachycardias in healthy or pathological substrates [<xref rid="B23-mps-02-00007" ref-type="bibr">23</xref>,<xref rid="B24-mps-02-00007" ref-type="bibr">24</xref>,<xref rid="B25-mps-02-00007" ref-type="bibr">25</xref>]. Optogenetics could be also employed to manipulate the conduction velocity and/or action potential duration using low light intensity illumination [<xref rid="B7-mps-02-00007" ref-type="bibr">7</xref>]. For example, selected areas of the heart could be statically illuminated with blue light inducing heterogeneities in conduction velocity and refractoriness during RT fixed delay stimulation, in order to mimic the effects of pathological substrates on re-entrant tachycardias.</p></sec></body><back><notes><title>Funding</title><p>This work was supported by the European Union Horizon 2020 research and innovation program under grant agreement no. 654148 Laserlab-Europe, by the Italian Ministry for Education, University and Research in the framework of the Flagship Project NANOMAX, by Ente Cassa Risparmio di Firenze (private foundation), and by FAS-Salute ToRSADE project. L.S. holds an EMBO short-term fellowship.</p></notes><notes notes-type="COI-statement"><title>Conflicts of Interest</title><p>The authors declare no conflict of interest.</p></notes><ref-list><title>References</title><ref id="B1-mps-02-00007"><label>1.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Deisseroth</surname><given-names>K.</given-names></name><name><surname>Feng</surname><given-names>G.</given-names></name><name><surname>Majewska</surname><given-names>A.</given-names></name><name><surname>Miesenbock</surname><given-names>G.</given-names></name><name><surname>Ting</surname><given-names>A.</given-names></name><name><surname>Schnitzer</surname><given-names>M.J.</given-names></name></person-group><article-title>Next-Generation Optical Technologies for Illuminating Genetically Targeted Brain Circuits</article-title><source>J. Neurosci.</source><year>2006</year><volume>26</volume><fpage>10380</fpage><lpage>10386</lpage><pub-id pub-id-type="doi">10.1523/JNEUROSCI.3863-06.2006</pub-id><?supplied-pmid 17035522?><pub-id pub-id-type="pmid">17035522</pub-id></element-citation></ref><ref id="B2-mps-02-00007"><label>2.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Nagel</surname><given-names>G.</given-names></name><name><surname>Brauner</surname><given-names>M.</given-names></name><name><surname>Liewald</surname><given-names>J.F.</given-names></name><name><surname>Adeishvili</surname><given-names>N.</given-names></name><name><surname>Bamberg</surname><given-names>E.</given-names></name><name><surname>Gottschalk</surname><given-names>A.</given-names></name></person-group><article-title>Light Activation of Channelrhodopsin-2 in Excitable Cells of <italic>Caenorhabditis Elegans</italic> Triggers Rapid Behavioral Responses</article-title><source>Curr. Biol.</source><year>2005</year><volume>15</volume><fpage>2279</fpage><lpage>2284</lpage><pub-id pub-id-type="doi">10.1016/j.cub.2005.11.032</pub-id><?supplied-pmid 16360690?><pub-id pub-id-type="pmid">16360690</pub-id></element-citation></ref><ref id="B3-mps-02-00007"><label>3.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Fenno</surname><given-names>L.</given-names></name><name><surname>Yizhar</surname><given-names>O.</given-names></name><name><surname>Deisseroth</surname><given-names>K.</given-names></name></person-group><article-title>The Development and Application of Optogenetics</article-title><source>Annu. Rev. Neurosci.</source><year>2011</year><volume>34</volume><fpage>389</fpage><lpage>412</lpage><pub-id pub-id-type="doi">10.1146/annurev-neuro-061010-113817</pub-id><?supplied-pmid 21692661?><pub-id pub-id-type="pmid">21692661</pub-id></element-citation></ref><ref id="B4-mps-02-00007"><label>4.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Entcheva</surname><given-names>E.</given-names></name></person-group><article-title>Cardiac Optogenetics</article-title><source>Am. J. Physiol. Heart Circ. Physiol.</source><year>2013</year><volume>304</volume><fpage>H1179</fpage><lpage>H1191</lpage><pub-id pub-id-type="doi">10.1152/ajpheart.00432.2012</pub-id><pub-id pub-id-type="pmid">23457014</pub-id></element-citation></ref><ref id="B5-mps-02-00007"><label>5.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Bruegmann</surname><given-names>T.</given-names></name><name><surname>Malan</surname><given-names>D.</given-names></name><name><surname>Hesse</surname><given-names>M.</given-names></name><name><surname>Beiert</surname><given-names>T.</given-names></name><name><surname>Fuegemann</surname><given-names>C.J.</given-names></name><name><surname>Fleischmann</surname><given-names>B.K.</given-names></name><name><surname>Sasse</surname><given-names>P.</given-names></name></person-group><article-title>Optogenetic Control of Heart Muscle <italic>in Vitro</italic> and <italic>in Vivo</italic></article-title><source>Nat. Methods</source><year>2010</year><volume>7</volume><fpage>897</fpage><lpage>900</lpage><pub-id pub-id-type="doi">10.1038/nmeth.1512</pub-id><?supplied-pmid 20881965?><pub-id pub-id-type="pmid">20881965</pub-id></element-citation></ref><ref id="B6-mps-02-00007"><label>6.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ambrosi</surname><given-names>C.M.</given-names></name><name><surname>Entcheva</surname><given-names>E.</given-names></name></person-group><article-title>Optogenetic Control of Cardiomyocytes Via Viral Delivery</article-title><source>Methods Mol. Biol.</source><year>2014</year><volume>1181</volume><fpage>215</fpage><lpage>228</lpage><?supplied-pmid 25070340?><pub-id pub-id-type="pmid">25070340</pub-id></element-citation></ref><ref id="B7-mps-02-00007"><label>7.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Burton</surname><given-names>R.A.</given-names></name><name><surname>Klimas</surname><given-names>A.</given-names></name><name><surname>Ambrosi</surname><given-names>C.M.</given-names></name><name><surname>Tomek</surname><given-names>J.</given-names></name><name><surname>Corbett</surname><given-names>A.</given-names></name><name><surname>Entcheva</surname><given-names>E.</given-names></name><name><surname>Bub</surname><given-names>G.</given-names></name></person-group><article-title>Optical Control of Excitation Waves in Cardiac Tissue</article-title><source>Nat. Photonics</source><year>2015</year><volume>9</volume><fpage>813</fpage><lpage>816</lpage><pub-id pub-id-type="doi">10.1038/nphoton.2015.196</pub-id><pub-id pub-id-type="pmid">27057206</pub-id></element-citation></ref><ref id="B8-mps-02-00007"><label>8.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Bingen</surname><given-names>B.O.</given-names></name><name><surname>Engels</surname><given-names>M.C.</given-names></name><name><surname>Schalij</surname><given-names>M.J.</given-names></name><name><surname>Jangsangthong</surname><given-names>W.</given-names></name><name><surname>Neshati</surname><given-names>Z.</given-names></name><name><surname>Feola</surname><given-names>I.</given-names></name><name><surname>Ypey</surname><given-names>D.L.</given-names></name><name><surname>Askar</surname><given-names>S.F.</given-names></name><name><surname>Panfilov</surname><given-names>A.V.</given-names></name><name><surname>Pijnappels</surname><given-names>D.A.</given-names></name><etal/></person-group><article-title>Light-Induced Termination of Spiral Wave Arrhythmias by Optogenetic Engineering of Atrial Cardiomyocytes</article-title><source>Cardiovasc. Res.</source><year>2014</year><volume>104</volume><fpage>194</fpage><lpage>205</lpage><pub-id pub-id-type="doi">10.1093/cvr/cvu179</pub-id><pub-id pub-id-type="pmid">25082848</pub-id></element-citation></ref><ref id="B9-mps-02-00007"><label>9.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Pianca</surname><given-names>N.</given-names></name><name><surname>Zaglia</surname><given-names>T.</given-names></name><name><surname>Mongillo</surname><given-names>M.</given-names></name></person-group><article-title>Will Cardiac Optogenetics Find the Way through the Obscure Angles of Heart Physiology?</article-title><source>Biochem. Biophys. Res. Commun.</source><year>2017</year><volume>482</volume><fpage>515</fpage><lpage>523</lpage><pub-id pub-id-type="doi">10.1016/j.bbrc.2016.11.104</pub-id><pub-id pub-id-type="pmid">27871856</pub-id></element-citation></ref><ref id="B10-mps-02-00007"><label>10.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Arrenberg</surname><given-names>A.B.</given-names></name><name><surname>Stainier</surname><given-names>D.Y.</given-names></name><name><surname>Baier</surname><given-names>H.</given-names></name><name><surname>Huisken</surname><given-names>J.</given-names></name></person-group><article-title>Optogenetic Control of Cardiac Function</article-title><source>Science</source><year>2010</year><volume>330</volume><fpage>971</fpage><lpage>974</lpage><pub-id pub-id-type="doi">10.1126/science.1195929</pub-id><pub-id pub-id-type="pmid">21071670</pub-id></element-citation></ref><ref id="B11-mps-02-00007"><label>11.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Johnston</surname><given-names>C.M.</given-names></name><name><surname>Rog-Zielinska</surname><given-names>E.A.</given-names></name><name><surname>Wulfers</surname><given-names>E.M.</given-names></name><name><surname>Houwaart</surname><given-names>T.</given-names></name><name><surname>Siedlecka</surname><given-names>U.</given-names></name><name><surname>Naumann</surname><given-names>A.</given-names></name><name><surname>Nitschke</surname><given-names>R.</given-names></name><name><surname>Knopfel</surname><given-names>T.</given-names></name><name><surname>Kohl</surname><given-names>P.</given-names></name><name><surname>Schneider-Warme</surname><given-names>F.</given-names></name></person-group><article-title>Optogenetic Targeting of Cardiac Myocytes and Non-Myocytes: Tools, Challenges and Utility</article-title><source>Prog. Biophys. Mol. Biol.</source><year>2017</year><volume>130 Pt B</volume><fpage>140</fpage><lpage>149</lpage><pub-id pub-id-type="doi">10.1016/j.pbiomolbio.2017.09.014</pub-id><pub-id pub-id-type="pmid">28919131</pub-id></element-citation></ref><ref id="B12-mps-02-00007"><label>12.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Entcheva</surname><given-names>E.</given-names></name><name><surname>Bub</surname><given-names>G.</given-names></name></person-group><article-title>All-Optical Control of Cardiac Excitation: Combined High-Resolution Optogenetic Actuation and Optical Mapping</article-title><source>J. Physiol.</source><year>2016</year><volume>594</volume><fpage>2503</fpage><lpage>2510</lpage><pub-id pub-id-type="doi">10.1113/JP271559</pub-id><?supplied-pmid 26857427?><pub-id pub-id-type="pmid">26857427</pub-id></element-citation></ref><ref id="B13-mps-02-00007"><label>13.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Crocini</surname><given-names>C.</given-names></name><name><surname>Ferrantini</surname><given-names>C.</given-names></name><name><surname>Pavone</surname><given-names>F.S.</given-names></name><name><surname>Sacconi</surname><given-names>L.</given-names></name></person-group><article-title>Optogenetics Gets to the Heart: A Guiding Light Beyond Defibrillation</article-title><source>Prog. Biophys. Mol. Biol.</source><year>2017</year><volume>130</volume><fpage>132</fpage><lpage>139</lpage><pub-id pub-id-type="doi">10.1016/j.pbiomolbio.2017.05.002</pub-id><?supplied-pmid 28506694?><pub-id pub-id-type="pmid">28506694</pub-id></element-citation></ref><ref id="B14-mps-02-00007"><label>14.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Zaglia</surname><given-names>T.</given-names></name><name><surname>Pianca</surname><given-names>N.</given-names></name><name><surname>Borile</surname><given-names>G.</given-names></name><name><surname>Da Broi</surname><given-names>F.</given-names></name><name><surname>Richter</surname><given-names>C.</given-names></name><name><surname>Campione</surname><given-names>M.</given-names></name><name><surname>Lehnart</surname><given-names>S.E.</given-names></name><name><surname>Luther</surname><given-names>S.</given-names></name><name><surname>Corrado</surname><given-names>D.</given-names></name><name><surname>Miquerol</surname><given-names>L.</given-names></name><etal/></person-group><article-title>Optogenetic Determination of the Myocardial Requirements for Extrasystoles by Cell Type-Specific Targeting of Channelrhodopsin-2</article-title><source>Proc. Natl. Acad. Sci. USA</source><year>2015</year><volume>112</volume><fpage>E4495</fpage><lpage>E4504</lpage><pub-id pub-id-type="doi">10.1073/pnas.1509380112</pub-id><?supplied-pmid 26204914?><pub-id pub-id-type="pmid">26204914</pub-id></element-citation></ref><ref id="B15-mps-02-00007"><label>15.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Nussinovitch</surname><given-names>U.</given-names></name><name><surname>Gepstein</surname><given-names>L.</given-names></name></person-group><article-title>Optogenetics for <italic>in Vivo</italic> Cardiac Pacing and Resynchronization Therapies</article-title><source>Nat. Biotechnol.</source><year>2015</year><volume>33</volume><fpage>750</fpage><lpage>754</lpage><pub-id pub-id-type="doi">10.1038/nbt.3268</pub-id><?supplied-pmid 26098449?><pub-id pub-id-type="pmid">26098449</pub-id></element-citation></ref><ref id="B16-mps-02-00007"><label>16.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Bruegmann</surname><given-names>T.</given-names></name><name><surname>Beiert</surname><given-names>T.</given-names></name><name><surname>Vogt</surname><given-names>C.C.</given-names></name><name><surname>Schrickel</surname><given-names>J.W.</given-names></name><name><surname>Sasse</surname><given-names>P.</given-names></name></person-group><article-title>Optogenetic Termination of Atrial Fibrillation in Mice</article-title><source>Cardiovasc. Res.</source><year>2018</year><volume>114</volume><fpage>713</fpage><lpage>723</lpage><pub-id pub-id-type="doi">10.1093/cvr/cvx250</pub-id><?supplied-pmid 29293898?><pub-id pub-id-type="pmid">29293898</pub-id></element-citation></ref><ref id="B17-mps-02-00007"><label>17.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Bruegmann</surname><given-names>T.</given-names></name><name><surname>Boyle</surname><given-names>P.M.</given-names></name><name><surname>Vogt</surname><given-names>C.C.</given-names></name><name><surname>Karathanos</surname><given-names>T.V.</given-names></name><name><surname>Arevalo</surname><given-names>H.J.</given-names></name><name><surname>Fleischmann</surname><given-names>B.K.</given-names></name><name><surname>Trayanova</surname><given-names>N.A.</given-names></name><name><surname>Sasse</surname><given-names>P.</given-names></name></person-group><article-title>Optogenetic Defibrillation Terminates Ventricular Arrhythmia in Mouse Hearts and Human Simulations</article-title><source>J. Clin. Investig.</source><year>2016</year><volume>126</volume><fpage>3894</fpage><lpage>3904</lpage><pub-id pub-id-type="doi">10.1172/JCI88950</pub-id><pub-id pub-id-type="pmid">27617859</pub-id></element-citation></ref><ref id="B18-mps-02-00007"><label>18.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Richter</surname><given-names>C.</given-names></name><name><surname>Christoph</surname><given-names>J.</given-names></name><name><surname>Lehnart</surname><given-names>S.E.</given-names></name><name><surname>Luther</surname><given-names>S.</given-names></name></person-group><article-title>Optogenetic Light Crafting Tools for the Control of Cardiac Arrhythmias</article-title><source>Methods Mol. Biol.</source><year>2016</year><volume>1408</volume><fpage>293</fpage><lpage>302</lpage><pub-id pub-id-type="pmid">26965131</pub-id></element-citation></ref><ref id="B19-mps-02-00007"><label>19.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Crocini</surname><given-names>C.</given-names></name><name><surname>Ferrantini</surname><given-names>C.</given-names></name><name><surname>Coppini</surname><given-names>R.</given-names></name><name><surname>Scardigli</surname><given-names>M.</given-names></name><name><surname>Yan</surname><given-names>P.</given-names></name><name><surname>Loew</surname><given-names>L.M.</given-names></name><name><surname>Smith</surname><given-names>G.</given-names></name><name><surname>Cerbai</surname><given-names>E.</given-names></name><name><surname>Poggesi</surname><given-names>C.</given-names></name><name><surname>Pavone</surname><given-names>F.S.</given-names></name><etal/></person-group><article-title>Optogenetics Design of Mechanistically-Based Stimulation Patterns for Cardiac Defibrillation</article-title><source>Sci. Rep.</source><year>2016</year><volume>6</volume><fpage>35628</fpage><pub-id pub-id-type="doi">10.1038/srep35628</pub-id><pub-id pub-id-type="pmid">27748433</pub-id></element-citation></ref><ref id="B20-mps-02-00007"><label>20.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Nyns</surname><given-names>E.C.A.</given-names></name><name><surname>Kip</surname><given-names>A.</given-names></name><name><surname>Bart</surname><given-names>C.I.</given-names></name><name><surname>Plomp</surname><given-names>J.J.</given-names></name><name><surname>Zeppenfeld</surname><given-names>K.</given-names></name><name><surname>Schalij</surname><given-names>M.J.</given-names></name><name><surname>de Vries</surname><given-names>A.A.F.</given-names></name><name><surname>Pijnappels</surname><given-names>D.A.</given-names></name></person-group><article-title>Optogenetic Termination of Ventricular Arrhythmias in the Whole Heart: Towards Biological Cardiac Rhythm Management</article-title><source>Eur. Heart J.</source><year>2017</year><volume>38</volume><fpage>2132</fpage><lpage>2136</lpage><pub-id pub-id-type="doi">10.1093/eurheartj/ehw574</pub-id><pub-id pub-id-type="pmid">28011703</pub-id></element-citation></ref><ref id="B21-mps-02-00007"><label>21.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Scardigli</surname><given-names>M.</given-names></name><name><surname>Mullenbroich</surname><given-names>C.</given-names></name><name><surname>Margoni</surname><given-names>E.</given-names></name><name><surname>Cannazzaro</surname><given-names>S.</given-names></name><name><surname>Crocini</surname><given-names>C.</given-names></name><name><surname>Ferrantini</surname><given-names>C.</given-names></name><name><surname>Coppini</surname><given-names>R.</given-names></name><name><surname>Yan</surname><given-names>P.</given-names></name><name><surname>Loew</surname><given-names>L.M.</given-names></name><name><surname>Campione</surname><given-names>M.</given-names></name><etal/></person-group><article-title>Real-Time Optical Manipulation of Cardiac Conduction in Intact Hearts</article-title><source>J. Physiol.</source><year>2018</year><volume>596</volume><fpage>3841</fpage><lpage>3858</lpage><pub-id pub-id-type="doi">10.1113/JP276283</pub-id><?supplied-pmid 29989169?><pub-id pub-id-type="pmid">29989169</pub-id></element-citation></ref><ref id="B22-mps-02-00007"><label>22.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Matiukas</surname><given-names>A.</given-names></name><name><surname>Mitrea</surname><given-names>B.G.</given-names></name><name><surname>Qin</surname><given-names>M.</given-names></name><name><surname>Pertsov</surname><given-names>A.M.</given-names></name><name><surname>Shvedko</surname><given-names>A.G.</given-names></name><name><surname>Warren</surname><given-names>M.D.</given-names></name><name><surname>Zaitsev</surname><given-names>A.V.</given-names></name><name><surname>Wuskell</surname><given-names>J.P.</given-names></name><name><surname>Wei</surname><given-names>M.D.</given-names></name><name><surname>Watras</surname><given-names>J.</given-names></name><etal/></person-group><article-title>Near-Infrared Voltage-Sensitive Fluorescent Dyes Optimized for Optical Mapping in Blood-Perfused Myocardium</article-title><source>Heart Rhythm</source><year>2007</year><volume>4</volume><fpage>1441</fpage><lpage>1451</lpage><pub-id pub-id-type="doi">10.1016/j.hrthm.2007.07.012</pub-id><?supplied-pmid 17954405?><pub-id pub-id-type="pmid">17954405</pub-id></element-citation></ref><ref id="B23-mps-02-00007"><label>23.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Fei</surname><given-names>H.</given-names></name><name><surname>Hanna</surname><given-names>M.S.</given-names></name><name><surname>Frame</surname><given-names>L.H.</given-names></name></person-group><article-title>Assessing the Excitable Gap in Reentry by Resetting. Implications for Tachycardia Termination by Premature Stimuli and Antiarrhythmic Drugs</article-title><source>Circulation</source><year>1996</year><volume>94</volume><fpage>2268</fpage><lpage>2277</lpage><pub-id pub-id-type="doi">10.1161/01.CIR.94.9.2268</pub-id><?supplied-pmid 8901682?><pub-id pub-id-type="pmid">8901682</pub-id></element-citation></ref><ref id="B24-mps-02-00007"><label>24.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Frame</surname><given-names>L.H.</given-names></name><name><surname>Simson</surname><given-names>M.B.</given-names></name></person-group><article-title>Oscillations of Conduction, Action Potential Duration, and Refractoriness. A Mechanism for Spontaneous Termination of Reentrant Tachycardias</article-title><source>Circulation</source><year>1988</year><volume>78 Pt 1</volume><fpage>1277</fpage><lpage>1287</lpage><pub-id pub-id-type="doi">10.1161/01.CIR.78.5.1277</pub-id><pub-id pub-id-type="pmid">3180384</pub-id></element-citation></ref><ref id="B25-mps-02-00007"><label>25.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kunysz</surname><given-names>A.M.</given-names></name><name><surname>Shrier</surname><given-names>A.</given-names></name><name><surname>Glass</surname><given-names>L.</given-names></name></person-group><article-title>Bursting Behavior During Fixed-Delay Stimulation of Spontaneously Beating Chick Heart Cell Aggregates</article-title><source>Am. J. Physiol.</source><year>1997</year><volume>273 Pt 1</volume><fpage>C331</fpage><lpage>C346</lpage><pub-id pub-id-type="doi">10.1152/ajpcell.1997.273.1.C331</pub-id><pub-id pub-id-type="pmid">9252472</pub-id></element-citation></ref></ref-list></back><floats-group><fig id="mps-02-00007-f001" orientation="portrait" position="float"><label>Figure 1</label><caption><p>Real-time architecture to mimic ventricular tachycardia. (<bold>a</bold>) Scheme of the wide-field fluorescence mesoscope in tandem with the workstation for real-time analysis and manipulation. Figure modified from [<xref rid="B21-mps-02-00007" ref-type="bibr">21</xref>]. LED, light-emitting diode; sCMOS, scientific complementary metal-oxide semiconductor; DMD, digital micro-mirror device; HDMI, high-definition multimedia interface. (<bold>b</bold>) At the top panel, the trace shows the corresponding fluorescent signal value in the detection region of interest (ROI; green rectangle). When the signal overcomes a set threshold (1%) the system closes the loop reinjecting a light stimulus. To the bottom, channelrhodopsin-2 (ChR2) stimulation at ventricle apex (blue spot) is applied to optically activate the heart. The wavefront propagation (dashed red lines) propagates from the apex to the base of the heart. When the propagating wave invades the detecting ROI (green rectangle) the system reinjects the light stimulus at the apex of the heart with a pre-defined delay (clock). The simulated ventricular tachycardia can be initiated by a single external optical or electrical stimulus or a spontaneously generated sinus beat.</p></caption><graphic xlink:href="mps-02-00007-g001"/></fig><fig id="mps-02-00007-f002" orientation="portrait" position="float"><label>Figure 2</label><caption><p>Conceptual Scheme of the LabVIEW Program Architecture. (<bold>a</bold>) Scheme of the LabVIEW program that manages the whole optical-mapping setup. The main program is principally composed by two loops: the IL (imaging loop) in blue and the RTL (real-time loop) in green. LED, light-emitting diode; sCMOS, scientific complementary metal-oxide semiconductor; DMD, digital micro-mirror device; HVCL, Hamamatsu video capture library; ROI, region of interest; FpS, frame per second; RAM, random access memory; R-Led, red LED; Amp (V), amplitude (Volts); USB, universal serial bus; F, false; T, true; Th, threshold; TIFF, tagged image file format. (<bold>b</bold>) Camera configuration. This block contains the HVCL functions to prepare the camera. (<bold>c</bold>) Representation of the portion of the camera sensor used. FOV, field of view. (<bold>d</bold>) Close camera. This block contains the operations to correctly stop and close the connection with the camera. (<bold>e</bold>) Legend of the symbol used in panel (<bold>a</bold>). SSD, solid state drive; HDD, hard disk drive. (<bold>f</bold>) List of the Hamamatsu Video Capture Library (HVCL) functions used.</p></caption><graphic xlink:href="mps-02-00007-g002"/></fig><fig id="mps-02-00007-f003" orientation="portrait" position="float"><label>Figure 3</label><caption><p>System performances at different time resolutions during 90 s of measurement. Imaging loop (IL) error rate calculated as the fraction of lost frames respect to total with real-time analysis loop (RTL) disabled (blue triangle) and enabled (red triangle). Real-time analysis loop error (black circle) calculated as the fraction of not analyzed frames respect to acquired frames.</p></caption><graphic xlink:href="mps-02-00007-g003"/></fig><fig id="mps-02-00007-f004" orientation="portrait" position="float"><label>Figure 4</label><caption><p>Stability of simulated ventricular tachycardia. (<bold>a</bold>) Fluorescent image of the heart. After detection of depolarization activity at the heart base (green ROI), the system stimulates ChR2 at ventricle apex (blue circle) using a delay of 200 ms. (<bold>b</bold>) Fluorescent signal (&#x02206;F/F) extracted from the green ROI shows a stable ventricular tachycardia during the entire time of the measurement (3 min). Note that the fluorescence of the di-4-ANBDQPQ voltage-sensitive dye (VSD) decreases during each membrane depolarization. (<bold>c</bold>) Zoom of the trace in panel (<bold>b</bold>): the green rectangle indicates the detection time of membrane depolarization, the dashed line indicates the delay period, and the blue circle indicates the time of ChR2 stimulation.</p></caption><graphic xlink:href="mps-02-00007-g004"/></fig></floats-group></article>